---
title: "MUSA 508, Assignment 2 - Spatial Machine Learning"
author: "Austin, Lan"
output: html_document
---

```{r setup, include=FALSE}
# You can set some global options for knitting chunks
knitr::opts_chunk$set(echo = TRUE)
```

**please choose and run this this chunk first everytime**
```{r set working directory}
# for Lan
setwd("/Users/lexi/Desktop/UPENN_COURSE/MUSA_508/assignment/assignment2")

# for Austin
#setwd("C:/Users/austi/Desktop/Penn/Classes/PublicPolicy/Assignments/Midterm")
```

```{r setup}
# Load some libraries
library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
#library(ggcorrplot)
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(mapview)

# functions and data directory
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

# color set up
# yellow to green
palette1 <- c('#f2d6a2', '#dfd688', '#ccd270', '#b8ca58', '#a4bf41')  # lighter one
palette2 <- c('#ffd358', '#e1cf5b', '#b9bc4e', '#879a32', '#4f6d00')   # stronger one
palette3 <- c('#f2d6a2', '#e9d596', '#dfd38a', '#d6d17e', '#ccce72', '#c2cb66', '#b8c85a', '#aec44d', '#a4bf41')  # lighter one with more gradient
```


# Data Wrangling

## Data Loading and Cleaning

**loading data and transforming in to 'ESRI:102254'**

**(glimpsing with mapview / simply plot)**

**removing error data and trimming data into county limits**
two ways to trim, select from "county" column, or use geometry

**(selecting a specific subset)**
sometimes need sometimes not, decisions will be made depending on group summary

load property-information data
```{r load physical characteristic data}
physical_data <- st_read("data/studentData.geojson") %>% 
  st_set_crs('ESRI:102254')
```
load Boulder city boundary
```{r load city boundary data}
city_boundary <- st_read("https://opendata.arcgis.com/datasets/955e7a0f52474b60a9866950daf10acb_0.geojson") %>% 
  st_transform('ESRI:102254') %>% 
  st_union() %>% 
  st_buffer(1) %>%
  st_sf()
```
load Boulder county boundary
```{r load county boundary data}
county_boundary <- st_read("https://opendata.arcgis.com/datasets/964b8f3b3dbe401bb28d49ac93d29dc4_0.geojson") %>% 
  st_transform('ESRI:102254') 
```
load and clean school attendance area data
```{r load school attendance area data}
# load elementaarea.elementaryry attendance are data - BVSD school district 
area.elementary <- st_read("data/BVSD_elmtr_area.geojson") %>% 
  st_transform('ESRI:102254') 
area.elementary$SchName <- toupper(area.elementary$SchName)

# trim within Boulder
area.elementary <- area.elementary[county_boundary,] %>% 
    dplyr::select(SchName, State_CD)

# load high school attendance are data - BVSD District 
area.high <- st_read("data/BVSD_hsc_area.geojson") %>% 
  st_transform('ESRI:102254') %>% 
  dplyr::select(SchName, FID, State_CD)
area.high$SchName <- toupper(area.high$SchName)

# merge FID 1&2
# only FID 1
area.FID1 <- st_union(
  area.high %>% 
    filter(FID == "1"),
  area.high %>% 
    filter(FID == "2")
) %>% 
  dplyr::select(SchName, State_CD)
# rbind FID 1 back
area.high <- rbind(
  area.FID1,
  area.high %>% 
    dplyr::filter(FID != "2", FID != "1") %>% 
    dplyr::select(SchName, State_CD)
) 

# trim within Boulder
area.high <- area.high[county_boundary,] 
```

load school data 
```{r load school data, message=FALSE}
# load school data
schools <- st_read("data/Public_Schools.geojson") %>% 
  st_transform('ESRI:102254')

# load schoolname comparison table
school.name <- st_read("data/BVSD_hsc.geojson") %>% 
  st_transform('ESRI:102254') %>% 
  dplyr::select(SHNAME, ICSCHNAME, CDEID) %>% 
  st_drop_geometry()
school.name$ICSCHNAME <- toupper(school.name$ICSCHNAME)
```
trim schools to those within Boulder county and select schools are operational and regular
```{r schools trim within Boulder}
# trim within Boulder
schools <- rbind(
  schools %>% 
    dplyr::filter(NAME == "BROOMFIELD HIGH SCHOOL"), # This school isn't within Boulder, but some Boulder residents should attend it
  schools[county_boundary,] %>% 
    dplyr::filter(COUNTY == 'BOULDER') %>% 
    # select regular schools
    dplyr::filter(TYPE == "1") %>% 
    # select operational schools
    dplyr::filter(STATUS == "1") %>% 
    dplyr::filter(NAME != "NEW VISTA HIGH SCHOOL")  # This school isn't in school district list
)
```
summary by school level
```{r select a subset of public school}
schools.summary <- schools %>% 
  group_by(LEVEL_) %>% 
  summarize(count = n(), students = sum(ENROLLMENT))
schools.summary
```
combine schools with attendance areas
```{r combine schools with attendance areas}
# select specific school in the attendance list
school.specific <- rbind(
  schools[area.elementary,] %>% 
    dplyr::filter(LEVEL_ == "ELEMENTARY"),
  schools[area.high,]%>% 
    dplyr::filter(LEVEL_ == "HIGH")
)
```
load school rating data
```{r load school rating data}
# load and filter by district
school.ratings <- read_csv("data/SPF_Final Ratings_2010-201.csv") %>% 
  dplyr::filter(DistrictName == "Boulder Valley Re 2")

# transfername to capital
school.ratings$Name <- toupper(x=school.ratings$Name)
```
combine school info with school ratings
```{r combine school info with school ratings}
# combine
school.tidy <- left_join(
  school.specific, 
  school.ratings, 
  by = c("NAME" = "Name")
)

# select variables
school.tidy <- school.tidy %>% 
  dplyr::select(NAME, LEVEL_, Total_Percent_Points)
```

load hospital data
```{r load hospital data, message=FALSE}
# load and select field
hospitals <- st_read("data/hOSPITALS.geojson") %>% 
  st_transform('ESRI:102254')
```
trim hospitals to those within Boulder county and select hospitals are general and open
```{r hospitals trim within Boulder}
# trim within Boulder
hospitals <- hospitals[county_boundary,] %>% 
  dplyr::filter(COUNTY == 'BOULDER') %>% 
  #select open hospitals
  dplyr::filter(STATUS == "OPEN") %>% 
  # select GENERAL MEDICAL AND SURGICAL HOSPITALS
  dplyr::filter(NAICS_DESC == "GENERAL MEDICAL AND SURGICAL HOSPITALS") %>% 
  # select variables
  dplyr::select(NAME, CITY, TRAUMA)
```


## Feature Engineering

**sum within census track** 
(least optional for most situation)

**sum within fixed buffer**
(assuming scale relationship uniform countywide)

**average distance of k-nearest case**
combine school data with sale data
```{r}
# combine with high school
sale <- physical_data %>% 
  st_join(area.high) %>% 
  st_sf() %>% 
  left_join(school.name, by = c("State_CD" = "CDEID"))
# rename column
colnames(sale)[52] <- 'high_school'

# combine with elementary school
sale <- sale %>% 
  st_join(area.elementary)%>% 
  st_sf()%>% 
  left_join(school.name, by = c("State_CD.y" = "CDEID"))
# rename column
colnames(sale)[56] <- 'elmtr_school'

# add distance to high school
# make a df contain school geometry with order
school.high.order <- sale %>% 
  st_drop_geometry() %>% 
  left_join(
    school.tidy %>% 
      filter(LEVEL_ == "HIGH"), 
    by = c("high_school" = "NAME")
    ) %>% 
  st_sf()
# caculate distance
sale <- sale %>% 
  dplyr::mutate(
    hsch_distance = st_distance(sale, school.high.order, by_element = TRUE)
  )

# add distance to elementary school
# make a df contain school geometry with order
school.elmtr.order <- sale %>% 
  st_drop_geometry() %>% 
  left_join(
    school.tidy %>% 
      filter(LEVEL_ == "ELEMENTARY"), 
    by = c("elmtr_school" = "NAME")
    ) %>% 
  st_sf()
# caculate distance
sale <- sale %>% 
  dplyr::mutate(
    elmtr_distance = st_distance(sale, school.elmtr.order, by_element = TRUE)
  )
# still have name not match
#ALICIA SANCHEZ ELEMENTARY SCHOOL
```


## Exploratory Analysis

**log**

# Regression

# Cross-Validation










